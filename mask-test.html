<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢å…·ä¹‹é­‚ï¼šæ¢å¯»ä½ çš„éæ´²éƒ¨è½åŒ–èº«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&family=Nunito:wght@400;700;900&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
      body {
        font-family: 'Nunito', 'PingFang SC', 'Microsoft YaHei', 'Heiti SC', sans-serif;
        background-color: #fdfbf7;
        overflow: hidden; 
        touch-action: none;
      }
      .font-hand {
        font-family: 'Gochi Hand', 'ZCOOL KuaiLe', 'YouYuan', 'Microsoft YaHei', sans-serif;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .bg-notebook-paper {
        background-color: #fdfbf7;
      }
      .perspective-container {
        perspective: 800px;
        perspective-origin: center bottom;
        transform-style: preserve-3d;
      }
      .pop-up-item {
        transform-origin: center bottom;
        transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      .is-flat {
        transform: rotateX(90deg) scale(0.8);
        opacity: 0.5;
      }
      .is-standing {
        transform: rotateX(0deg) scale(1);
        opacity: 1;
      }
      @keyframes bounce-move {
        0%, 100% { transform: translateY(0) scale(1) scaleY(1); }
        25% { transform: translateY(-3px) scale(1.02) scaleY(0.98); }
        50% { transform: translateY(-6px) scale(1.04) scaleY(0.96); }
        75% { transform: translateY(-3px) scale(1.02) scaleY(0.98); }
      }
      .animate-bounce-move {
        animation: bounce-move 0.9s infinite ease-in-out;
      }
      @keyframes leg-swing {
        0%, 100% { transform: rotate(-20deg); }
        25% { transform: rotate(-15deg); }
        50% { transform: rotate(20deg); }
        75% { transform: rotate(15deg); }
      }
      @keyframes leg-swing-opp {
        0%, 100% { transform: rotate(20deg); }
        25% { transform: rotate(15deg); }
        50% { transform: rotate(-20deg); }
        75% { transform: rotate(-15deg); }
      }
      @keyframes arm-swing {
        0%, 100% { transform: rotate(15deg); }
        25% { transform: rotate(10deg); }
        50% { transform: rotate(-15deg); }
        75% { transform: rotate(-10deg); }
      }
      @keyframes arm-swing-opp {
        0%, 100% { transform: rotate(-15deg); }
        25% { transform: rotate(-10deg); }
        50% { transform: rotate(15deg); }
        75% { transform: rotate(10deg); }
      }
      .animate-leg {
        transform-origin: 45px 75px;
        animation: leg-swing 0.9s infinite ease-in-out;
      }
      .animate-leg-opp {
        transform-origin: 55px 75px;
        animation: leg-swing-opp 0.9s infinite ease-in-out;
      }
      .animate-arm {
        transform-origin: 40px 55px;
        animation: arm-swing 0.9s infinite ease-in-out;
      }
      .animate-arm-opp {
        transform-origin: 60px 55px;
        animation: arm-swing-opp 0.9s infinite ease-in-out;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
      }
      /* å¯¼èˆªæ ç›¸å…³æ ·å¼ */
      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      }

      /* ç¡®ä¿å¯¼èˆªæ å…ƒç´ å…·æœ‰æ­£ç¡®çš„z-index */
      .dropdown-menu {
        z-index: 51;
      }
      
      .dropdown-overlay {
        z-index: 50;
      }
      
      .search-panel {
        z-index: 52;
      }

      /* è¿”å›æŒ‰é’®æ ·å¼ - è°ƒæ•´ä½ç½®ä»¥é¿å…ä¸å¯¼èˆªæ é‡å  */
      .back-button {
        backdrop-filter: blur(8px);
        z-index: 53;
        top: 75px; /* è°ƒæ•´ä¸ºå¯¼èˆªæ é«˜åº¦ + è¾¹è· */
      }
      .back-button:hover {
        transform: scale(1.05);
      }
      .back-button:active {
        transform: translate(2px, 2px);
      }

      /* ä¸ºä¸»æ¸¸æˆå®¹å™¨æ·»åŠ é¡¶éƒ¨paddingï¼Œé¿å…è¢«å¯¼èˆªæ é®æŒ¡ */
      #root {
        padding-top: 60px;
      }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header" id="header">
        <div class="header-container">
            <button class="menu-toggle" id="menuToggle" aria-label="Menu">
                <span class="menu-line"></span>
                <span class="menu-line"></span>
                <span class="menu-line"></span>
            </button>
            
            <div class="logo">
                <a href="index.html" class="logo-link">Tribal Echo</a>
            </div>
            
            <div class="header-actions">
                <button class="search-btn" id="searchBtn" aria-label="Search">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸‹æ‹‰èœå• -->
    <nav class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-menu-content">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="index.html#global-south" class="nav-link">The Global South</a>
                </li>
                <li class="nav-item">
                    <a href="index.html#tribes-masks" class="nav-link">Tribes And Masks</a>
                </li>
                <li class="nav-item">
                    <a href="index.html#african-instruments" class="nav-link">African Instruments</a>
                </li>
                <li class="nav-item">
                    <a href="index.html#soul-mask" class="nav-link">The Soul Of The Mask</a>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- ä¸‹æ‹‰èœå•é®ç½© -->
    <div class="dropdown-overlay" id="dropdownOverlay"></div>

    <!-- æœç´¢é¢æ¿ -->
    <div class="search-panel" id="searchPanel">
        <div class="search-panel-container">
            <input type="text" class="search-input" placeholder="Search for articles, projects, creatives..." autofocus>
            <button class="search-close" id="searchClose" aria-label="Close search">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
    </div>


    
    <div id="root" class="w-full h-screen relative overflow-hidden"></div>
    
    <script>
        const WORLD_HEIGHT = 4000;
        let targetIndex = 0;
        
        let gameState = {
            currentWaypointIndex: 0,
            characterPosition: { x: 50, y: 420 },
            cameraY: 0,
            scene: 'INTRO',
            isMoving: false,
            answers: [],
            finalResult: null,
        };

        const QUESTIONS = [
            {
                id: 1,
                text: "ç¬¬ä¸€é¢˜ï¼šåœ¨ç¤¾äº¤åœºåˆä¸­ï¼Œä½ é€šå¸¸æ˜¯ï¼Ÿ",
                options: [
                    { text: "A. ç»„ç»‡è€…ï¼Œç¡®ä¿ä¸€åˆ‡æœ‰åºè¿›è¡Œ", type: 'A' },
                    { text: "B. åˆ†äº«è€…ï¼Œè®²è¿°æœ‰è¶£çš„ç»å†", type: 'B' },
                    { text: "C. è°ƒè§£è€…ï¼Œå¸®åŠ©å¤§å®¶å’Œç¦ç›¸å¤„", type: 'C' },
                    { text: "D. è§‚å¯Ÿè€…ï¼Œé»˜é»˜æ„Ÿå—æ°›å›´", type: 'D' },
                ]
            },
            {
                id: 2,
                text: "ç¬¬äºŒé¢˜ï¼šé¢å¯¹æœªçŸ¥çš„æŒ‘æˆ˜ï¼Œä½ é¦–å…ˆä¼šï¼Ÿ",
                options: [
                    { text: "A. ç›´æ¥æœæ–­åœ°è§£å†³é—®é¢˜", type: 'A' },
                    { text: "B. è§‚å¯Ÿåˆ†ææœ¬è´¨å’Œè§„å¾‹", type: 'B' },
                    { text: "C. è”ç³»åŒä¼´ï¼Œå¯»æ±‚åä½œ", type: 'C' },
                    { text: "D. é¡ºåº”èŠ‚å¥ï¼Œè°ƒæ•´çŠ¶æ€", type: 'D' },
                ]
            },
            {
                id: 3,
                text: "ç¬¬ä¸‰é¢˜ï¼šä½ è®¤ä¸ºçœŸæ­£çš„åŠ›é‡æ¥è‡ªï¼Ÿ",
                options: [
                    { text: "A. çºªå¾‹å’Œæ„å¿—åŠ›", type: 'A' },
                    { text: "B. æ™ºæ…§å’Œåˆ›é€ åŠ›", type: 'B' },
                    { text: "C. æ²Ÿé€šå’Œç†è§£", type: 'C' },
                    { text: "D. ä¸è‡ªç„¶çš„è¿æ¥", type: 'D' },
                ]
            },
            {
                id: 4,
                text: "ç¬¬å››é¢˜ï¼šåœ¨å›¢é˜Ÿä¸­ï¼Œä½ æœ€é‡è§†ï¼Ÿ",
                options: [
                    { text: "A. æ˜ç¡®çš„ç›®æ ‡å’Œæ‰§è¡ŒåŠ›", type: 'A' },
                    { text: "B. è‡ªç”±è¡¨è¾¾å’Œåˆ›æ–°ç©ºé—´", type: 'B' },
                    { text: "C. å’Œè°çš„æ°›å›´å’Œæƒ…æ„Ÿè¿æ¥", type: 'C' },
                    { text: "D. ä¸ç¯å¢ƒçš„å’Œè°å…±ç”Ÿ", type: 'D' },
                ]
            },
            {
                id: 5,
                text: "ç¬¬äº”é¢˜ï¼šä½ æœ€æ“…é•¿çš„å­¦ä¹ æ–¹å¼æ˜¯ï¼Ÿ",
                options: [
                    { text: "A. ç³»ç»ŸåŒ–å­¦ä¹ å’Œå®è·µ", type: 'A' },
                    { text: "B. è‡ªç”±æ¢ç´¢å’Œè¯•é”™", type: 'B' },
                    { text: "C. ä¸ä»–äººè®¨è®ºäº¤æµ", type: 'C' },
                    { text: "D. äº²èº«ä½“éªŒå’Œæ„Ÿæ‚Ÿ", type: 'D' },
                ]
            },
            {
                id: 6,
                text: "ç¬¬å…­é¢˜ï¼šä½ æ›´åçˆ±å“ªç§åˆ›ä½œæ–¹å¼ï¼Ÿ",
                options: [
                    { text: "A. æ„å»ºå®å¤§çš„ä½“ç³»", type: 'A' },
                    { text: "B. è§£æ„å¤æ‚çš„æ¦‚å¿µ", type: 'B' },
                    { text: "C. ç¼–ç»‡ç²¾å¦™çš„æ•…äº‹", type: 'C' },
                    { text: "D. æ„Ÿå—å³å…´çš„çµæ„Ÿ", type: 'D' },
                ]
            },
            {
                id: 7,
                text: "ç¬¬ä¸ƒé¢˜ï¼šä½ è®¤ä¸ºä»€ä¹ˆæ˜¯ç†æƒ³çš„ç¤¾åŒºï¼Ÿ",
                options: [
                    { text: "A. çºªå¾‹ä¸¥æ˜çš„å ¡å’", type: 'A' },
                    { text: "B. æ€æƒ³è‡ªç”±çš„å­¦åŸ", type: 'B' },
                    { text: "C. å¹³ç­‰äº’åŠ©çš„è”ç›Ÿ", type: 'C' },
                    { text: "D. äº²è¿‘è‡ªç„¶çš„éƒ¨è½", type: 'D' },
                ]
            },
            {
                id: 8,
                text: "ç¬¬å…«é¢˜ï¼šä½ å¦‚ä½•å®šä¹‰è‡ªå·±çš„ç¾ï¼Ÿ",
                options: [
                    { text: "A. åŠ›é‡ä¹‹ç¾", type: 'A' },
                    { text: "B. æ™ºæ…§ä¹‹ç¾", type: 'B' },
                    { text: "C. å’Œè°ä¹‹ç¾", type: 'C' },
                    { text: "D. æœ¬çœŸä¹‹ç¾", type: 'D' },
                ]
            }
        ];

        const ASSETS = {
            avatar: "ğŸ—¿", 
            totems: ["ğŸ¦", "ğŸº", "ğŸ", "ğŸ”¥", "ğŸ¥", "ğŸ­", "ğŸ¦…", "ğŸŒ"],
            trees: ["ğŸŒ³", "ğŸŒ´", "ğŸŒµ", "ğŸŒ¿"],
            houses: ["ğŸ›–", "â›º"],
            rocks: ["ğŸª¨", "â›°ï¸"],
        };

        const WAYPOINTS = [
            { pos: { x: 50, y: 420 } },
            { pos: { x: 20, y: 450 }, questionId: 1, totem: ASSETS.totems[0] },
            { pos: { x: 80, y: 750 }, questionId: 2, totem: ASSETS.totems[1] },
            { pos: { x: 30, y: 1100 }, questionId: 3, totem: ASSETS.totems[2] },
            { pos: { x: 70, y: 1450 }, questionId: 4, totem: ASSETS.totems[3] },
            { pos: { x: 25, y: 1850 }, questionId: 5, totem: ASSETS.totems[4] },
            { pos: { x: 75, y: 2200 }, questionId: 6, totem: ASSETS.totems[5] },
            { pos: { x: 20, y: 2600 }, questionId: 7, totem: ASSETS.totems[6] },
            { pos: { x: 50, y: 3000 }, questionId: 8, totem: ASSETS.totems[7] },
            { pos: { x: 50, y: 3400 }, isEnd: true },
        ];

        const SCENERY = [
            { id: 's1', asset: ASSETS.trees[0], x: 70, y: 350, scale: 1.2, rotation: -5 },
            { id: 's2', asset: ASSETS.houses[0], x: 80, y: 400, scale: 1.5, rotation: 5 },
            { id: 's3', asset: ASSETS.rocks[1], x: 20, y: 650, scale: 1.0, rotation: 0 },
            { id: 's4', asset: ASSETS.trees[1], x: 30, y: 750, scale: 1.3, rotation: 10 },
            { id: 's5', asset: ASSETS.trees[2], x: 75, y: 1050, scale: 0.9, rotation: -8 },
            { id: 's6', asset: ASSETS.houses[1], x: 85, y: 1150, scale: 1.4, rotation: 3 },
            { id: 's7', asset: ASSETS.trees[3], x: 20, y: 1400, scale: 1.1, rotation: -3 },
            { id: 's8', asset: ASSETS.rocks[0], x: 10, y: 1500, scale: 0.8, rotation: 15 },
            { id: 's9', asset: ASSETS.trees[0], x: 80, y: 1800, scale: 1.5, rotation: 5 },
            { id: 's10', asset: ASSETS.houses[0], x: 70, y: 1900, scale: 1.2, rotation: -5 },
            { id: 's11', asset: ASSETS.trees[1], x: 25, y: 2150, scale: 1.0, rotation: 8 },
            { id: 's12', asset: ASSETS.rocks[1], x: 15, y: 2250, scale: 1.3, rotation: -2 },
            { id: 's13', asset: ASSETS.trees[2], x: 80, y: 2550, scale: 1.4, rotation: 4 },
            { id: 's14', asset: ASSETS.houses[1], x: 70, y: 2650, scale: 1.1, rotation: -6 },
        ];

        const RIVER_PATHS = [
            "M -50 900 C 200 750, 400 1100, 650 950 C 900 800, 1100 1150, 1350 1000 C 1600 850, 1800 1200, 2050 1050",
            "M 100 2300 C 300 2100, 500 2500, 750 2350 C 1000 2200, 1200 2600, 1450 2450 C 1700 2300, 1900 2700, 2050 2550"
        ];

        const RESULTS = {
            '1': {
                id: '1',
                name: "é²å‹’æ— Â· ç¥–å…ˆé¢å…· ",
                title: "å’Œè°å‹äººæ ¼ Â· ç¾å­¦æ ‡æ†",
                trait: "ä¼˜é›…",
                strength: "å¹³è¡¡",
                skill: "é¢œå€¼ç»´ç¨³",
                desc: "ä½ å´‡å°šå¹¶åˆ›é€ ç€ä¸€åˆ‡å½¢å¼çš„ç¾ä¸å’Œè°ã€‚æ˜¯ç¤¾äº¤åœˆé‡Œçš„å®šæµ·ç¥é’ˆï¼Œèƒ½ç”¨æ¸©æŸ”çš„åŠ›é‡æŠšå¹³æ¯›èºï¼Œè®©ä¸–ç•Œå˜å¾—ä¼˜é›…ä»å®¹ã€‚",
                color: "bg-red-100",
                icon: "ğŸ›¡ï¸"
            },
            '2': {
                id: '2',
                name: "å¡åŠªç¦éƒ¨è½ Â· å¾·æ ¼å‹’é¢å…·",
                title: "åŠ›é‡å‹äººæ ¼ Â· é‡æ€§å›¾è…¾",
                trait: "å®ˆæŠ¤",
                strength: "å¨æ…‘",
                skill: "é©±é‚ªé¿ç¾",
                desc: "ä½ æ˜¯æŠµå¾¡è´Ÿé¢èƒ½é‡çš„å±éšœï¼ŒåŸå§‹åŠ›é‡çš„åŒ–èº«ã€‚æ°”åœºå¦‚åŒä¸ç­çš„ç«ç„°ï¼Œèƒ½å®ˆæŠ¤ç¤¾ç¾¤çš„å®‰å®ä¸çº¯å‡€ã€‚",
                color: "bg-green-100",
                icon: "ğŸŒ¾"
            },
            '3': {
                id: '3',
                name: "å¤šè´¡éƒ¨è½ Â· å¤§é¢å…·",
                title: "å“²æ€å‹äººæ ¼ Â· å®‡å®™æ¨¡ç»„",
                trait: "æ·±é‚ƒ",
                strength: "æ´å¯Ÿ",
                skill: "å‚é€æœ¬è´¨",
                desc: "ä½ çš„ç²¾ç¥è¿æ¥ç€æ˜Ÿè¾°ä¸å¤è€æ™ºæ…§ã€‚å–œæ¬¢æ¢å¯»ä¸‡ç‰©è§„å¾‹ï¼Œæ˜¯æœ‹å‹ä¸­è¡Œèµ°çš„ç™¾ç§‘åœ£å…‰ï¼Œæ€»èƒ½å¸¦æ¥é™ç»´æ‰“å‡»çš„å¯å‘ã€‚",
                color: "bg-indigo-100",
                icon: "ğŸŒŒ"
            },
            '4': {
                id: '4',
                name: "å·´åº“å·´æ— Â· é‚¦åšé¢å…·",
                title: "é¢†è¢–å‹äººæ ¼ Â· å¤©é€‰è´µæ—",
                trait: "åä¸½",
                strength: "ç»Ÿå¾¡",
                skill: "åä¸½æ§åœº",
                desc: " ä½ çš„é­…åŠ›æ¥è‡ªä¸ç”Ÿä¿±æ¥çš„æ ¼å±€ä¸æ°”åœºã€‚æ— éœ€åˆ»æ„å¼ºè°ƒï¼Œå°±èƒ½æˆä¸ºäººç¾¤çš„ä¸­å¿ƒï¼ŒæŒ‡å¼•æ–¹å‘ï¼Œå¤©ç”Ÿå°±æ˜¯å¤§åœºé¢ç©å®¶ã€‚",
                color: "bg-blue-100",
                icon: "ğŸ¦"
            },
            '5': {
                id: '5',
                name: "ä¸¹äºº Â· ä¸¹é¢å…·",
                title: "è°ƒè§£å‹äººæ ¼ Â· å’Œå¹³åŸºç«™",
                trait: "å®é™",
                strength: "å‡èš",
                skill: "åŒ–å¹²æˆˆä¸ºç‰å¸›",
                desc: "ä½ æ‹¥æœ‰è®©å¯¹ç«‹åŒæ–¹å†·é™ä¸‹æ¥çš„é­”åŠ›ã€‚æ˜¯äººé™…å…³ç³»çš„æ¶¦æ»‘å‰‚ï¼Œæ€»èƒ½ç²¾å‡†æ‰¾åˆ°å…±è¯†ï¼Œè®©ä¸–ç•Œå› ä½ è€Œæ›´å›¢ç»“ã€‚",
                color: "bg-orange-100",
                icon: "ğŸ¤"
            },
            '6': {
                id: '6',
                name: "é©¬åº·å¾·éƒ¨è½ Â· è°¢å¡”å°¼é¢å…·",
                title: "çµæ„Ÿå‹äººæ ¼ Â· æ¢¦å¢ƒæ•æ‰‹",
                trait: "æŠ½è±¡",
                strength: "åˆ›æ„",
                skill: "è„‘æ´å¼€èŠ±",
                desc: "ä½ çš„æ€ç»´ä¸å—é‡åŠ›æŸç¼šï¼Œæ˜¯å¤©ç”Ÿçš„å¹»æƒ³å»ºç­‘å¸ˆã€‚æ€»èƒ½ä»å¼‚æ¬¡å…ƒå¸¦æ¥æƒŠå–œï¼Œæ˜¯å›¢é˜Ÿé‡Œä¸å¯æˆ–ç¼ºçš„çµæ„Ÿæ°¸åŠ¨æœºã€‚",
                color: "bg-yellow-100",
                icon: "âš”ï¸"
            },
            '7': {
                id: '7',
                name: "çº¦é²å·´éƒ¨è½ Â· ç›–è±å¾·é¢å…·",
                title: "æ²Ÿé€šå‹äººæ ¼ Â· å¹½é»˜è§‚å¯Ÿå®¶",
                trait: "è¯™è°",
                strength: "è­¦ä¸–",
                skill: "å¯“æ•™äºä¹",
                desc: "ä½ æ“…é•¿ç”¨å¹½é»˜åŒ…è£¹æ™ºæ…§ï¼Œåœ¨æ¬¢å£°ç¬‘è¯­ä¸­ç‚¹ç ´çœŸç›¸ã€‚æ˜¯æ´å¯Ÿäººæ€§çš„ç¤¾äº¤è‰ºæœ¯å®¶ï¼Œä½ çš„â€œåæ§½â€æ€»è®©äººå¿ƒæœå£æœã€‚",
                color: "bg-purple-100",
                icon: "âš–ï¸"
            },
            '8': {
                id: '8',
                name: "æ™®åŠªäºº Â· æ™®åŠªé¢å…·",
                title: "çµæ€§äººæ ¼ Â· ç¥–çµä¹‹æ¡¥",
                trait: "å…¸é›…",
                strength: "è¿æ¥",
                skill: "é€šçµå¯¹è¯",
                desc: "ä½ çš„æ°”è´¨æ²‰é™è€Œé€šé€ï¼Œå¦‚åŒè¿æ¥å¤©åœ°çš„ç™½æ¡¦ã€‚èƒ½è½»æ˜“è†å¬æ¥è‡ªè¿‡å»ä¸è‡ªç„¶çš„å£°éŸ³ï¼Œæ˜¯æ¸©æŸ”çš„çµæ€§åª’ä»‹ã€‚",
                color: "bg-amber-100",
                icon: "ğŸ“¿"
            }
        };

        function renderGame() {
            const root = document.getElementById('root');
            
            switch(gameState.scene) {
                case 'INTRO':
                    renderIntro(root);
                    break;
                case 'WALKING':
                    renderWalking(root);
                    break;
                case 'QUIZ_STOP':
                    renderWalking(root);
                    setTimeout(() => renderQuiz(root), 100);
                    break;
                case 'ENDING':
                    renderResult(root);
                    break;
                default:
                    renderWalking(root);
            }
        }

        function renderIntro(container) {
            container.innerHTML = `
                <div class="absolute w-full h-full bg-notebook-paper" style="height: ${WORLD_HEIGHT}px;">
                    <!-- Notebook Lines Layer (bottom layer) -->
                    <div class="absolute inset-0 pointer-events-none" style="z-index: 0; background-image: linear-gradient(#e5e7eb 1px, transparent 1px); background-size: 100% 24px; opacity: 0.5;"></div>
                    
                    <!-- Scenery Items (only first few for intro) -->
                    ${SCENERY.filter(item => item.y < 600).map(item => `
                        <div class="absolute pointer-events-none select-none" style="left: ${item.x}%; top: ${item.y}px; font-size: 3.5rem; z-index: 1; filter: contrast(1.1) sepia(0.3); mix-blend-mode: multiply; opacity: 0.85; transform: rotate(${item.rotation}deg) scale(${item.scale});">
                            ${item.asset}
                        </div>
                    `).join('')}

                    <!-- Waypoint Totems (only first few) -->
                    ${WAYPOINTS.slice(0, 3).map((wp, idx) => {
                        if (!wp.totem) return '';
                        return `
                            <div class="absolute" style="left: ${wp.pos.x}%; top: ${wp.pos.y}px; width: 60px; height: 60px; margin-left: -30px; margin-top: -50px; z-index: 2;">
                                <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-12 h-4 bg-black/10 rounded-[100%] blur-[2px]"></div>
                                <div class="w-full h-full flex items-end justify-center text-5xl opacity-50">
                                    <div class="relative filter drop-shadow-sm">${wp.totem}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}

                    <div class="absolute w-full top-[60px] flex flex-col items-center text-center px-6 z-20">
                        <h1 class="text-6xl font-hand font-black text-amber-900 mb-6 tracking-tighter mix-blend-multiply opacity-90">
                            é¢å…·ä¹‹é­‚
                        </h1>
                        <div class="font-hand text-amber-800 leading-relaxed max-w-sm mix-blend-multiply opacity-80 flex flex-col items-center">
                            <span class="block border-b-2 border-amber-900/10 pb-3 mb-3 text-3xl font-bold">æ¢å¯»ä½ çš„éæ´²éƒ¨è½åŒ–èº«</span>
                            <span class="text-xl font-normal">æµ‹æµ‹ä½ æ˜¯ä»€ä¹ˆç±»å‹çš„éæ´²éƒ¨è½é¢å…·</span>
                        </div>
                        
                        <button onclick="startGame()" class="mt-60 px-8 py-3 bg-[#fdfbf7] border-2 border-amber-900 text-amber-900 font-hand text-2xl rounded-sm shadow-[4px_4px_0px_0px_#5D4037] hover:bg-amber-50 active:shadow-none active:translate-x-1 active:translate-y-1 transition-all">
                            å¼€å§‹æ—…ç¨‹
                        </button>
                    </div>

                    <div class="absolute z-30" style="left: 50%; top: 420px; transform: translate(-50%, -90%);">
                        <div class="absolute bottom-1 left-1/2 -translate-x-1/2 w-12 h-4 bg-black/20 rounded-[100%] blur-[1.5px]"></div>
                        <div class="relative w-32 h-32">
                            ${getCharacterSVG(false)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWalking(container) {
            const footprints = generateFootprints();
            const totems = WAYPOINTS.map((wp, idx) => {
                if (!wp.totem) return null;
                const isReached = idx <= gameState.currentWaypointIndex;
                return `
                    <div class="absolute" style="left: ${wp.pos.x}%; top: ${wp.pos.y}px; width: 60px; height: 60px; margin-left: -30px; margin-top: -50px; z-index: 2;">
                        <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-12 h-4 bg-black/10 rounded-[100%] blur-[2px] transition-opacity duration-500 ${isReached ? 'opacity-100' : 'opacity-0'}"></div>
                        <div class="w-full h-full flex items-end justify-center text-5xl ${isReached ? 'opacity-100' : 'opacity-50'}">
                            <div class="relative filter drop-shadow-sm">${wp.totem}</div>
                        </div>
                    </div>
                `;
            }).filter(Boolean).join('');

            container.innerHTML = `
                <div class="absolute w-full h-full bg-notebook-paper transition-transform duration-500" style="transform: translateY(-${gameState.cameraY}px); height: ${WORLD_HEIGHT}px;">
                    
                    <!-- Notebook Lines Layer (bottom layer) -->
                    <div class="absolute inset-0 pointer-events-none" style="z-index: 0; background-image: linear-gradient(#e5e7eb 1px, transparent 1px); background-size: 100% 24px; opacity: 0.3;"></div>
                    
                    <!-- River Layer -->
                    <svg class="absolute top-0 left-0 w-full h-full pointer-events-none" style="z-index: 0">
                        ${RIVER_PATHS.map((path, idx) => `
                            <path d="${path}" fill="none" stroke="#a5d8ff" stroke-width="50" stroke-linecap="round" style="mix-blend-mode: multiply; opacity: 0.6" />
                        `).join('')}
                    </svg>

                    <!-- Footprints -->
                    ${footprints.map(fp => `
                        <div class="absolute opacity-30 pointer-events-none" style="left: ${fp.x}%; top: ${fp.y}px; width: 8px; height: 10px; background-color: #5D4037; border-radius: 50%; transform: translate(-50%, -50%) rotate(${fp.rotation}deg); z-index: 1;"></div>
                    `).join('')}

                    <!-- Scenery Items -->
                    ${SCENERY.map(item => `
                        <div class="absolute pointer-events-none select-none" style="left: ${item.x}%; top: ${item.y}px; font-size: 3.5rem; z-index: 2; filter: contrast(1.1) sepia(0.3); mix-blend-mode: multiply; opacity: 0.85; transform: rotate(${item.rotation}deg) scale(${item.scale});">
                            ${item.asset}
                        </div>
                    `).join('')}

                    <!-- Waypoint Totems -->
                    ${totems}

                    <!-- Character -->
                    <div class="absolute z-30" style="left: ${gameState.characterPosition.x}%; top: ${gameState.characterPosition.y}px; transform: translate(-50%, -90%);">
                        <div class="absolute bottom-1 left-1/2 -translate-x-1/2 w-12 h-4 bg-black/20 rounded-[100%] blur-[1.5px]"></div>
                        <div class="relative w-32 h-32 ${gameState.isMoving ? 'animate-bounce-move' : ''}">
                            ${getCharacterSVG(gameState.isMoving)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQuiz(container) {
            // åˆ›å»ºé—®é¢˜èƒŒæ™¯å›¾ç‰‡æ˜ å°„
            const questionBackgrounds = {
                '1': 'photo/é—®é¢˜èƒŒæ™¯/é¢˜ç›®1.png',
                '2': 'photo/é—®é¢˜èƒŒæ™¯/é¢˜ç›®2.png',
                '3': 'photo/é—®é¢˜èƒŒæ™¯/é¢˜ç›®3.png',
                '4': 'photo/é—®é¢˜èƒŒæ™¯/é¢˜ç›®4.png',
                '5': 'photo/é—®é¢˜èƒŒæ™¯/é¢˜ç›®5.png',
                '6': 'photo/é—®é¢˜èƒŒæ™¯/é¢˜ç›®6.png',
                '7': 'photo/é—®é¢˜èƒŒæ™¯/é¢˜ç›®7.png',
                '8': 'photo/é—®é¢˜èƒŒæ™¯/é¢˜ç›®8.png'
            };

            // é¦–å…ˆæ¸²æŸ“èƒŒæ™¯åœºæ™¯
            const footprints = generateFootprints();
            const totems = WAYPOINTS.map((wp, idx) => {
                if (!wp.totem) return null;
                const isReached = idx <= gameState.currentWaypointIndex;
                return `
                    <div class="absolute" style="left: ${wp.pos.x}%; top: ${wp.pos.y}px; width: 60px; height: 60px; margin-left: -30px; margin-top: -50px; z-index: 2;">
                        <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-12 h-4 bg-black/10 rounded-[100%] blur-[2px] transition-opacity duration-500 ${isReached ? 'opacity-100' : 'opacity-0'}"></div>
                        <div class="w-full h-full flex items-end justify-center text-5xl ${isReached ? 'opacity-100' : 'opacity-50'}">
                            <div class="relative filter drop-shadow-sm">${wp.totem}</div>
                        </div>
                    </div>
                `;
            }).filter(Boolean).join('');

            const currentWaypointData = WAYPOINTS[gameState.currentWaypointIndex];
            const currentQuestion = QUESTIONS.find(q => q.id === currentWaypointData.questionId);
            
            let optionsHTML = '';
            for (let i = 0; i < currentQuestion.options.length; i++) {
                const opt = currentQuestion.options[i];
                optionsHTML += `
                    <button
                        onclick="selectAnswer('${opt.type}')"
                        class="text-left p-4 bg-[#fdfbf7]/85 border-2 border-[#fdfbf7]/100 hover:border-amber-200 hover:bg-[#fdfbf7]/100 transition-all font-hand text-[14px] text-amber-900 rounded-sm active:scale-[0.99]"
                    >
                        <span class="font-bold mr-2 text-amber-600">${opt.text.split('.')[0]}.</span>
                        ${opt.text.split('.').slice(1).join('.')}
                    </button>
                `;
            }
            
            container.innerHTML = `
                <!-- Background Scene -->
                <div class="absolute w-full h-full bg-notebook-paper transition-transform duration-500" style="transform: translateY(-${gameState.cameraY}px); height: ${WORLD_HEIGHT}px;">
                    
                    <!-- Notebook Lines Layer (bottom layer) -->
                    <div class="absolute inset-0 pointer-events-none" style="z-index: 0; background-image: linear-gradient(#e5e7eb 1px, transparent 1px); background-size: 100% 24px; opacity: 0.3;"></div>
                    
                    <!-- River Layer -->
                    <svg class="absolute top-0 left-0 w-full h-full pointer-events-none" style="z-index: 0">
                        ${RIVER_PATHS.map((path, idx) => `
                            <path d="${path}" fill="none" stroke="#a5d8ff" stroke-width="50" stroke-linecap="round" style="mix-blend-mode: multiply; opacity: 0.6" />
                        `).join('')}
                    </svg>

                    <!-- Footprints -->
                    ${footprints.map(fp => `
                        <div class="absolute opacity-30 pointer-events-none" style="left: ${fp.x}%; top: ${fp.y}px; width: 8px; height: 10px; background-color: #5D4037; border-radius: 50%; transform: translate(-50%, -50%) rotate(${fp.rotation}deg); z-index: 1;"></div>
                    `).join('')}

                    <!-- Scenery Items -->
                    ${SCENERY.map(item => `
                        <div class="absolute pointer-events-none select-none" style="left: ${item.x}%; top: ${item.y}px; font-size: 3.5rem; z-index: 2; filter: contrast(1.1) sepia(0.3); mix-blend-mode: multiply; opacity: 0.85; transform: rotate(${item.rotation}deg) scale(${item.scale});">
                            ${item.asset}
                        </div>
                    `).join('')}

                    <!-- Waypoint Totems -->
                    ${totems}

                    <!-- Character -->
                    <div class="absolute z-30" style="left: ${gameState.characterPosition.x}%; top: ${gameState.characterPosition.y}px; transform: translate(-50%, -90%);">
                        <div class="absolute bottom-1 left-1/2 -translate-x-1/2 w-12 h-4 bg-black/20 rounded-[100%] blur-[1.5px]"></div>
                        <div class="relative w-32 h-32">
                            ${getCharacterSVG(false)}
                        </div>
                    </div>
                </div>
                
                <!-- Question Card Overlay -->
                <div class="absolute inset-0 z-50 flex items-center justify-center p-4 fade-in">
                    <div class="w-full max-w-[500px] p-6 border-2 border-amber-900 shadow-[8px_8px_0px_0px_rgba(60,40,30,0.15)] rounded-sm flex flex-col max-h-[85vh] relative transform rotate-1" 
                         style="background-image: url('${questionBackgrounds[currentQuestion.id]}'); 
                                background-size: cover; 
                                background-position: center; 
                                background-repeat: no-repeat;">
                        

                        
                        <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-6 bg-amber-400/30 rotate-[-2deg] shadow-sm backdrop-blur-sm z-10"></div>

                        <!-- å¡ç‰‡å†…å®¹ï¼ˆç›¸å¯¹å®šä½ï¼Œç¡®ä¿åœ¨åŠé€æ˜å±‚ä¹‹ä¸Šï¼‰ -->
                        <div class="relative z-10">
                            <div class="text-amber-800 text-xs font-bold uppercase tracking-widest mb-4 text-center shrink-0 font-hand">
                                Checkpoint ${currentQuestion.id}
                            </div>
                            
                            <div class="overflow-y-auto mb-6 shrink-0 text-center">
                                <h3 class="text-2xl font-hand text-white leading-tight drop-shadow-[3px_3px_0_rgba(139,69,19,1.0)]">
                                    ${currentQuestion.text}
                                </h3>
                            </div>

                            <div class="grid grid-cols-2 gap-3 overflow-y-auto flex-1 pr-1">
                                ${optionsHTML}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderResult(container) {
            const result = RESULTS[gameState.finalResult];
            
            // åˆ›å»ºé¢å…·å›¾ç‰‡è·¯å¾„æ˜ å°„
            const maskImages = {
                '1': 'photo/é¢å…·é›†åˆ/1.ç¥–å…ˆé¢å…·.jpg',
                '2': 'photo/é¢å…·é›†åˆ/2.å¾·æ ¼å‹’é¢å…·.jpg', 
                '3': 'photo/é¢å…·é›†åˆ/3.å¤§é¢å…·.jpg',
                '4': 'photo/é¢å…·é›†åˆ/4.é‚¦åšé¢å…·.jpg',
                '5': 'photo/é¢å…·é›†åˆ/5.ä¸¹é¢å…·.jpg',
                '6': 'photo/é¢å…·é›†åˆ/6.è°¢å¡”å°¼é¢å…·.jpg',
                '7': 'photo/é¢å…·é›†åˆ/7.ç›–è±å¾·é¢å…·.jpg',
                '8': 'photo/é¢å…·é›†åˆ/8.æ™®åŠªé¢å…·.jpg'
            };
            
            container.innerHTML = `
                <div class="absolute inset-0 z-50 flex items-center justify-center bg-[#fdfbf7]/95 fade-in">
                    <div class="w-full h-full max-w-md overflow-y-auto p-6 flex flex-col items-center justify-center">
                        <div class="w-full bg-white border-2 border-amber-950 p-6 shadow-[10px_10px_0_0_rgba(0,0,0,0.05)] rounded-sm relative shrink-0 transform -rotate-1">
                            <div class="absolute -top-4 right-10 w-24 h-8 bg-red-400/20 rotate-3 backdrop-blur-sm"></div>

                            <!-- é¢å…·å›¾ç‰‡åŒºåŸŸ -->
                            <div class="relative mb-6">
                                <div class="w-80 h-auto mx-auto shadow-lg p-2">
                                    <img src="${maskImages[gameState.finalResult]}" 
                                         alt="${result.name}" 
                                         class="w-full h-auto object-contain"
                                         style="max-height: 400px;"
                                         onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-7xl opacity-90 mix-blend-multiply\\'>${result.icon}</div>'">
                                </div>
                            </div>

                            <div class="text-center mb-6">
                                <h3 class="text-2xl md:text-3xl font-bold font-hand text-amber-900 leading-none">
                                    ${result.title}
                                </h3>
                            </div>

                            <div class="text-center font-hand text-sm text-amber-900 mb-6 bg-stone-50 p-3 rounded border border-dashed border-stone-300">
                                <div class="flex flex-col justify-center">
                                    <div class="opacity-50 text-[10px] uppercase mb-2">æ‹¿æ‰‹å¥½æˆ</div>
                                    <span class="font-bold text-lg">${result.skill}</span>
                                </div>
                            </div>

                            <div class="text-center mb-6">
                                <p class="text-sm leading-relaxed text-amber-800 font-hand">
                                    ${result.desc}
                                </p>
                            </div>

                            <div class="flex justify-center gap-3">
                                <button onclick="resetGame()" class="px-4 py-2 bg-amber-800 border-2 border-amber-600 text-white font-normal rounded hover:bg-amber-900 transition-all font-hand">
                                    é‡æ–°æµ‹è¯•
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateFootprints() {
            const prints = [];
            const REF_WIDTH = 400;

            const generateSegment = (start, end, maxDist) => {
                const sx = (start.x / 100) * REF_WIDTH;
                const sy = start.y;
                const ex = (end.x / 100) * REF_WIDTH;
                const ey = end.y;

                const dx = ex - sx;
                const dy = ey - sy;
                const fullDist = Math.sqrt(dx*dx + dy*dy);
                const angleRad = Math.atan2(dy, dx);
                const angleDeg = (angleRad * 180) / Math.PI;

                const stepSize = 25;
                const count = Math.floor(fullDist / stepSize);
                
                for (let i = 1; i <= count; i++) {
                    const distFromStart = i * stepSize;
                    
                    if (maxDist !== undefined && distFromStart > maxDist) break;

                    const t = distFromStart / fullDist;
                    const bx = sx + dx * t;
                    const by = sy + dy * t;

                    const isRight = i % 2 === 0;
                    const offsetAmt = 5;
                    const nx = -Math.sin(angleRad);
                    const ny = Math.cos(angleRad);
                    const sideMult = isRight ? 1 : -1;
                    
                    const fx = bx + (nx * offsetAmt * sideMult);
                    const fy = by + (ny * offsetAmt * sideMult);
                    const xPct = (fx / REF_WIDTH) * 100;

                    prints.push({
                        x: xPct,
                        y: fy,
                        rotation: angleDeg + 90,
                        id: `${start.x}-${start.y}-${i}`
                    });
                }
            };

            // History segments
            for (let i = 0; i < gameState.currentWaypointIndex; i++) {
                if (WAYPOINTS[i+1]) {
                    generateSegment(WAYPOINTS[i].pos, WAYPOINTS[i+1].pos);
                }
            }

            // Current active segment
            if (gameState.isMoving && WAYPOINTS[gameState.currentWaypointIndex] && WAYPOINTS[gameState.currentWaypointIndex+1]) {
                const start = WAYPOINTS[gameState.currentWaypointIndex].pos;
                const sx = (start.x / 100) * REF_WIDTH;
                const sy = start.y;
                const cx = (gameState.characterPosition.x / 100) * REF_WIDTH;
                const cy = gameState.characterPosition.y;
                
                const travelledDist = Math.sqrt(Math.pow(cx - sx, 2) + Math.pow(cy - sy, 2));
                generateSegment(start, WAYPOINTS[gameState.currentWaypointIndex+1].pos, travelledDist);
            }

            return prints;
        }

        function getCharacterSVG(isAnimating) {
            return `
                <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md">
                    <g>
                        <!-- å·¦è…¿ -->
                        <g class="${isAnimating ? 'animate-leg' : ''}" style="transform-origin: 45px 75px;">
                            <path d="M45 75 L45 95" stroke="#8D5524" stroke-width="6" stroke-linecap="round" />
                        </g>
                        <!-- å·¦è‡‚ -->
                        <g class="${isAnimating ? 'animate-arm' : ''}" style="transform-origin: 40px 55px;">
                            <path d="M40 55 L30 65" stroke="#8D5524" stroke-width="5" stroke-linecap="round" />
                        </g>
                        <!-- èº«ä½“è£…é¥° -->
                        <path d="M36 70 L42 85 L48 70" fill="#b45309" />
                        <path d="M42 70 L48 85 L54 70" fill="#b45309" />
                        <rect x="38" y="48" width="24" height="26" rx="4" fill="#8D5524" />
                        <path d="M38 48 L38 72 L46 72 L46 48 Z" fill="#9a3412" />
                        <path d="M54 48 L54 72 L62 72 L62 48 Z" fill="#9a3412" />
                        <!-- å³è…¿ -->
                        <g class="${isAnimating ? 'animate-leg-opp' : ''}" style="transform-origin: 55px 75px;">
                            <path d="M55 75 L55 95" stroke="#8D5524" stroke-width="6" stroke-linecap="round" />
                        </g>
                        <!-- è‰è£™ -->
                        <path d="M34 72 L38 88 L42 75 L46 88 L50 75 L54 88 L58 75 L62 88 L66 72" fill="#eab308" stroke="#a16207" stroke-width="1" stroke-linejoin="round" />
                        <path d="M34 72 L66 72" stroke="#713f12" stroke-width="3" stroke-linecap="round" />
                        <!-- å¤´éƒ¨ -->
                        <circle cx="50" cy="38" r="17" fill="#8D5524" />
                        <path d="M33 32 Q50 22 67 32" stroke="#fbbf24" stroke-width="3" fill="none" />
                        <path d="M44 22 L40 5 L48 15" fill="#ef4444" />
                        <circle cx="54" cy="36" r="2" fill="#1a1a1a" />
                        <circle cx="62" cy="36" r="2" fill="#1a1a1a" />
                        <path d="M52 42 L56 44" stroke="#fff" stroke-width="2" opacity="0.6" stroke-linecap="round" />
                        <path d="M60 42 L64 44" stroke="#fff" stroke-width="2" opacity="0.6" stroke-linecap="round" />
                        <!-- å³è‡‚ -->
                        <g class="${isAnimating ? 'animate-arm-opp' : ''}" style="transform-origin: 60px 55px;">
                            <path d="M60 55 L70 65" stroke="#8D5524" stroke-width="5" stroke-linecap="round" />
                        </g>
                    </g>
                </svg>
            `;
        }

        function startGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.currentWaypointIndex = 0;
            gameState.characterPosition = WAYPOINTS[0].pos;
            gameState.cameraY = 0;
            gameState.scene = 'WALKING';
            gameState.isMoving = false;
            gameState.answers = [];
            gameState.finalResult = null;
            
            targetIndex = 1;
            moveCharacter();
        }

        function moveCharacter() {
            if (targetIndex >= WAYPOINTS.length) {
                return;
            }

            const nextIndex = targetIndex;
            const startPos = WAYPOINTS[gameState.currentWaypointIndex].pos;
            const endPos = WAYPOINTS[nextIndex].pos;
            
            let progress = 0;
            const speed = 0.015; // ä¼˜åŒ–åçš„è¡Œèµ°é€Ÿåº¦ï¼Œæ›´è‡ªç„¶çš„èŠ‚å¥

            function animate() {
                progress += speed;
                if (progress >= 1) {
                    progress = 1;
                    gameState.currentWaypointIndex = nextIndex;
                    gameState.isMoving = false;
                    
                    const currentPoint = WAYPOINTS[gameState.currentWaypointIndex];
                    
                    if (currentPoint.questionId && !currentPoint.isEnd) {
                        gameState.scene = 'QUIZ_STOP';
                    } else if (currentPoint.isEnd) {
                        calculateResult();
                    }
                    
                    renderGame();
                    return;
                }

                const newX = startPos.x + (endPos.x - startPos.x) * progress;
                const newY = startPos.y + (endPos.y - startPos.y) * progress;

                const viewportHeight = window.innerHeight;
                let targetCameraY = newY - (viewportHeight * 0.5);
                if (targetCameraY < 0) targetCameraY = 0;
                if (targetCameraY > WORLD_HEIGHT - viewportHeight) targetCameraY = WORLD_HEIGHT - viewportHeight;

                gameState.characterPosition = { x: newX, y: newY };
                gameState.cameraY = targetCameraY;
                gameState.scene = 'WALKING';
                gameState.isMoving = true;

                renderGame();
                requestAnimationFrame(animate);
            }

            animate();
        }

        function selectAnswer(type) {
            gameState.answers.push(type);
            gameState.scene = 'WALKING';
            targetIndex++;
            
            // å»¶è¿Ÿä¸€ä¸‹å†å¼€å§‹ç§»åŠ¨ï¼Œè®©ç”¨æˆ·çœ‹åˆ°é€‰æ‹©çš„åé¦ˆ
            setTimeout(() => {
                moveCharacter();
            }, 300);
        }

        function calculateResult() {
            const counts = { A: 0, B: 0, C: 0, D: 0 };
            gameState.answers.forEach(a => {
                if (counts[a] !== undefined) counts[a]++;
            });

            const maxScore = Math.max(counts.A, counts.B, counts.C, counts.D);
            
            if (counts.A === counts.B && counts.B === counts.C && counts.C === counts.D) {
                gameState.finalResult = '7';
            } else {
                let dominant = '';
                if (counts.A === maxScore) dominant = 'A';
                else if (counts.B === maxScore) dominant = 'B';
                else if (counts.C === maxScore) dominant = 'C';
                else dominant = 'D';

                let possibleResults = [];
                if (dominant === 'A') possibleResults = ['1', '5'];
                if (dominant === 'B') possibleResults = ['3', '8'];
                if (dominant === 'C') possibleResults = ['4', '7'];
                if (dominant === 'D') possibleResults = ['2', '6'];

                const hash = gameState.answers.join('').split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                gameState.finalResult = possibleResults[hash % possibleResults.length];
            }

            gameState.scene = 'ENDING';
            renderGame();
        }

        function resetGame() {
            gameState = {
                currentWaypointIndex: 0,
                characterPosition: WAYPOINTS[0].pos,
                cameraY: 0,
                scene: 'INTRO',
                isMoving: false,
                answers: [],
                finalResult: null,
            };
            targetIndex = 0;
            renderGame();
        }



        document.addEventListener('DOMContentLoaded', function() {
            renderGame();
        });

        window.startGame = startGame;
        window.selectAnswer = selectAnswer;
        window.resetGame = resetGame;
        window.moveCharacter = moveCharacter;

        // ========== å¯¼èˆªæ åŠŸèƒ½ ==========
        let header, menuToggle, dropdownMenu, dropdownOverlay, searchBtn, searchPanel, searchClose;

        function initializeNavigation() {
            header = document.getElementById('header');
            menuToggle = document.getElementById('menuToggle');
            dropdownMenu = document.getElementById('dropdownMenu');
            dropdownOverlay = document.getElementById('dropdownOverlay');
            searchBtn = document.getElementById('searchBtn');
            searchPanel = document.getElementById('searchPanel');
            searchClose = document.getElementById('searchClose');

            setupDropdownMenu();
            setupSearchPanel();
        }

        function updateDropdownPosition() {
            if (!header || !dropdownMenu) return;
            
            const headerRect = header.getBoundingClientRect();
            const topPosition = headerRect.bottom;
            dropdownMenu.style.top = `${topPosition}px`;
        }

        function openDropdownMenu() {
            if (!dropdownMenu || !dropdownOverlay || !menuToggle) return;
            
            updateDropdownPosition();
            dropdownMenu.classList.add('active');
            dropdownOverlay.classList.add('active');
            menuToggle.classList.add('active');
        }

        function closeDropdownMenu() {
            if (!dropdownMenu || !dropdownOverlay || !menuToggle) return;
            
            dropdownMenu.classList.remove('active');
            dropdownOverlay.classList.remove('active');
            menuToggle.classList.remove('active');
        }

        function setupDropdownMenu() {
            if (!menuToggle || !dropdownOverlay) return;
            
            menuToggle.addEventListener('click', () => {
                if (dropdownMenu.classList.contains('active')) {
                    closeDropdownMenu();
                } else {
                    openDropdownMenu();
                }
            });

            dropdownOverlay.addEventListener('click', closeDropdownMenu);

            // æ»šåŠ¨æ—¶æ›´æ–°ä¸‹æ‹‰èœå•ä½ç½®
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                if (dropdownMenu && dropdownMenu.classList.contains('active')) {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        updateDropdownPosition();
                    }, 10);
                }
            });

            // ç‚¹å‡»å¯¼èˆªé“¾æ¥åå…³é—­èœå•
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', closeDropdownMenu);
            });
        }

        function openSearch() {
            if (!searchPanel) return;
            
            searchPanel.classList.add('active');
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                const searchInput = document.querySelector('.search-input');
                if (searchInput) {
                    searchInput.focus();
                }
            }, 300);
        }

        function closeSearch() {
            if (!searchPanel) return;
            
            searchPanel.classList.remove('active');
            document.body.style.overflow = '';
        }

        function setupSearchPanel() {
            if (!searchBtn || !searchClose) return;
            
            searchBtn.addEventListener('click', openSearch);
            searchClose.addEventListener('click', closeSearch);

            // ESC é”®å…³é—­æœç´¢
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && searchPanel && searchPanel.classList.contains('active')) {
                    closeSearch();
                }
            });
        }

        // åˆå§‹åŒ–å¯¼èˆªæ åŠŸèƒ½
        initializeNavigation();
    </script>
</body>
</html>